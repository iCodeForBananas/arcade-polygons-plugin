function flatten(t){return[].concat.apply([],t)}!function(t,o){"use strict";"function"==typeof define&&define.amd?define(o):"object"==typeof exports?module.exports=o():t.SAT=o()}(this,function(){"use strict";function t(t,o){this.x=t||0,this.y=o||0}function o(o,e){this.pos=o||new t,this.r=e||0}function e(o,e){this.pos=o||new t,this.angle=0,this.offset=new t,this.setPoints(e||[])}function r(o,e,r){this.pos=o||new t,this.w=e||0,this.h=r||0}function n(){this.a=null,this.b=null,this.overlapN=new t,this.overlapV=new t,this.clear()}function s(t,o,e){for(var r=Number.MAX_VALUE,n=-Number.MAX_VALUE,s=t.length,i=0;i<s;i++){var p=t[i].dot(o);p<r&&(r=p),p>n&&(n=p)}e[0]=r,e[1]=n}function i(t,o,e,r,n,i){var p=v.pop(),a=v.pop(),l=g.pop().copy(o).sub(t),c=l.dot(n);if(s(e,n,p),s(r,n,a),a[0]+=c,a[1]+=c,p[0]>a[1]||a[0]>p[1])return g.push(l),v.push(p),v.push(a),!0;if(i){var h=0;if(p[0]<a[0])if(i.aInB=!1,p[1]<a[1])h=p[1]-a[0],i.bInA=!1;else{var y=p[1]-a[0],u=a[1]-p[0];h=y<u?y:-u}else if(i.bInA=!1,p[1]>a[1])h=p[0]-a[1],i.aInB=!1;else{var y=p[1]-a[0],u=a[1]-p[0];h=y<u?y:-u}var f=Math.abs(h);f<i.overlap&&(i.overlap=f,i.overlapN.copy(n),h<0&&i.overlapN.reverse())}return g.push(l),v.push(p),v.push(a),!1}function p(t,o){var e=t.len2(),r=o.dot(t);return r<0?A:r>e?w:x}function a(t,o){var e=g.pop().copy(t).sub(o.pos),r=o.r*o.r,n=e.len2();return g.push(e),n<=r}function l(t,o){b.pos.copy(t),P.clear();var e=u(b,o,P);return e&&(e=P.aInB),e}function c(t,o,e){var r=g.pop().copy(o.pos).sub(t.pos),n=t.r+o.r,s=n*n,i=r.len2();if(i>s)return g.push(r),!1;if(e){var p=Math.sqrt(i);e.a=t,e.b=o,e.overlap=n-p,e.overlapN.copy(r.normalize()),e.overlapV.copy(r).scale(e.overlap),e.aInB=t.r<=o.r&&p<=o.r-t.r,e.bInA=o.r<=t.r&&p<=t.r-o.r}return g.push(r),!0}function h(t,o,e){for(var r=g.pop().copy(o.pos).sub(t.pos),n=o.r,s=n*n,i=t.calcPoints,a=i.length,l=g.pop(),c=g.pop(),h=0;h<a;h++){var y=h===a-1?0:h+1,u=0===h?a-1:h-1,f=0,d=null;l.copy(t.edges[h]),c.copy(r).sub(i[h]),e&&c.len2()>s&&(e.aInB=!1);var v=p(l,c);if(v===A){l.copy(t.edges[u]);var P=g.pop().copy(r).sub(i[u]);if(v=p(l,P),v===w){var b=c.len();if(b>n)return g.push(r),g.push(l),g.push(c),g.push(P),!1;e&&(e.bInA=!1,d=c.normalize(),f=n-b)}g.push(P)}else if(v===w){if(l.copy(t.edges[y]),c.copy(r).sub(i[y]),v=p(l,c),v===A){var b=c.len();if(b>n)return g.push(r),g.push(l),g.push(c),!1;e&&(e.bInA=!1,d=c.normalize(),f=n-b)}}else{var x=l.perp().normalize(),b=c.dot(x),m=Math.abs(b);if(b>0&&m>n)return g.push(r),g.push(x),g.push(c),!1;e&&(d=x,f=n-b,(b>=0||f<2*n)&&(e.bInA=!1))}d&&e&&Math.abs(f)<Math.abs(e.overlap)&&(e.overlap=f,e.overlapN.copy(d))}return e&&(e.a=t,e.b=o,e.overlapV.copy(e.overlapN).scale(e.overlap)),g.push(r),g.push(l),g.push(c),!0}function y(t,o,e){var r=h(o,t,e);if(r&&e){var n=e.a,s=e.aInB;e.overlapN.reverse(),e.overlapV.reverse(),e.a=e.b,e.b=n,e.aInB=e.bInA,e.bInA=s}return r}function u(t,o,e){for(var r=t.calcPoints,n=r.length,s=o.calcPoints,p=s.length,a=0;a<n;a++)if(i(t.pos,o.pos,r,s,t.normals[a],e))return!1;for(var a=0;a<p;a++)if(i(t.pos,o.pos,r,s,o.normals[a],e))return!1;return e&&(e.a=t,e.b=o,e.overlapV.copy(e.overlapN).scale(e.overlap)),!0}var f={};f.Vector=t,f.V=t,t.prototype.copy=t.prototype.copy=function(t){return this.x=t.x,this.y=t.y,this},t.prototype.clone=t.prototype.clone=function(){return new t(this.x,this.y)},t.prototype.perp=t.prototype.perp=function(){var t=this.x;return this.x=this.y,this.y=-t,this},t.prototype.rotate=t.prototype.rotate=function(t){var o=this.x,e=this.y;return this.x=o*Math.cos(t)-e*Math.sin(t),this.y=o*Math.sin(t)+e*Math.cos(t),this},t.prototype.reverse=t.prototype.reverse=function(){return this.x=-this.x,this.y=-this.y,this},t.prototype.normalize=t.prototype.normalize=function(){var t=this.len();return t>0&&(this.x=this.x/t,this.y=this.y/t),this},t.prototype.add=t.prototype.add=function(t){return this.x+=t.x,this.y+=t.y,this},t.prototype.sub=t.prototype.sub=function(t){return this.x-=t.x,this.y-=t.y,this},t.prototype.scale=t.prototype.scale=function(t,o){return this.x*=t,this.y*=o||t,this},t.prototype.project=t.prototype.project=function(t){var o=this.dot(t)/t.len2();return this.x=o*t.x,this.y=o*t.y,this},t.prototype.projectN=t.prototype.projectN=function(t){var o=this.dot(t);return this.x=o*t.x,this.y=o*t.y,this},t.prototype.reflect=t.prototype.reflect=function(t){var o=this.x,e=this.y;return this.project(t).scale(2),this.x-=o,this.y-=e,this},t.prototype.reflectN=t.prototype.reflectN=function(t){var o=this.x,e=this.y;return this.projectN(t).scale(2),this.x-=o,this.y-=e,this},t.prototype.dot=t.prototype.dot=function(t){return this.x*t.x+this.y*t.y},t.prototype.len2=t.prototype.len2=function(){return this.dot(this)},t.prototype.len=t.prototype.len=function(){return Math.sqrt(this.len2())},f.Circle=o,o.prototype.getAABB=o.prototype.getAABB=function(){var o=this.r,e=this.pos.clone().sub(new t(o,o));return new r(e,2*o,2*o).toPolygon()},f.Polygon=e,e.prototype.setPoints=e.prototype.setPoints=function(o){var e=!this.points||this.points.length!==o.length;if(e){var r,n=this.calcPoints=[],s=this.edges=[],i=this.normals=[];for(r=0;r<o.length;r++)n.push(new t),s.push(new t),i.push(new t)}return this.points=o,this._recalc(),this},e.prototype.setAngle=e.prototype.setAngle=function(t){return this.angle=t,this._recalc(),this},e.prototype.setOffset=e.prototype.setOffset=function(t){return this.offset=t,this._recalc(),this},e.prototype.rotate=e.prototype.rotate=function(t){for(var o=this.points,e=o.length,r=0;r<e;r++)o[r].rotate(t);return this._recalc(),this},e.prototype.translate=e.prototype.translate=function(t,o){for(var e=this.points,r=e.length,n=0;n<r;n++)e[n].x+=t,e[n].y+=o;return this._recalc(),this},e.prototype._recalc=function(){var t,o=this.calcPoints,e=this.edges,r=this.normals,n=this.points,s=this.offset,i=this.angle,p=n.length;for(t=0;t<p;t++){var a=o[t].copy(n[t]);a.x+=s.x,a.y+=s.y,0!==i&&a.rotate(i)}for(t=0;t<p;t++){var l=o[t],c=t<p-1?o[t+1]:o[0],h=e[t].copy(c).sub(l);r[t].copy(h).perp().normalize()}return this},e.prototype.getAABB=e.prototype.getAABB=function(){for(var o=this.calcPoints,e=o.length,n=o[0].x,s=o[0].y,i=o[0].x,p=o[0].y,a=1;a<e;a++){var l=o[a];l.x<n?n=l.x:l.x>i&&(i=l.x),l.y<s?s=l.y:l.y>p&&(p=l.y)}return new r(this.pos.clone().add(new t(n,s)),i-n,p-s).toPolygon()},f.Box=r,r.prototype.toPolygon=r.prototype.toPolygon=function(){var o=this.pos,r=this.w,n=this.h;return new e(new t(o.x,o.y),[new t,new t(r,0),new t(r,n),new t(0,n)])},f.Response=n,n.prototype.clear=n.prototype.clear=function(){return this.aInB=!0,this.bInA=!0,this.overlap=Number.MAX_VALUE,this};for(var g=[],d=0;d<10;d++)g.push(new t);for(var v=[],d=0;d<5;d++)v.push([]);var P=new n,b=new r(new t,1e-6,1e-6).toPolygon();f.isSeparatingAxis=i;var A=-1,x=0,w=1;return f.pointInCircle=a,f.pointInPolygon=l,f.testCircleCircle=c,f.testPolygonCircle=h,f.testCirclePolygon=y,f.testPolygonPolygon=u,f}),Phaser.Plugin.ArcadePolygons=function(t,o){Phaser.Plugin.call(this,t,o),this.facade=new Phaser.Plugin.ArcadePolygons.Facade},Phaser.Plugin.ArcadePolygons.prototype=Object.create(Phaser.Plugin.prototype),Phaser.Plugin.ArcadePolygons.prototype.constructor=Phaser.Plugin.ArcadePolygons,Phaser.Plugin.ArcadePolygons.VERSION="1",Phaser.Plugin.ArcadePolygons.prototype.init=function(){this.game.arcadePolygons=this.game.arcadePolygons||this.facade,this.originalCollideSpriteVsGroup=Phaser.Physics.Arcade.prototype.collideSpriteVsGroup,Phaser.Physics.Arcade.prototype.collideSpriteVsGroup=Phaser.Plugin.ArcadePolygons.Overrides.collideSpriteVsGroup},Phaser.Plugin.ArcadePolygons.prototype.destroy=function(){this.game.arcadePolygons=null,Phaser.Physics.Arcade.prototype.collideSpriteVsGroup=this.originalCollideSpriteVsGroup,Phaser.Plugin.prototype.destroy.call(this)},Phaser.Plugin.ArcadePolygons.Facade=function(){},Phaser.Plugin.ArcadePolygons.Facade.prototype.enable=function(t,o){if(Array.isArray(t))for(var e=0;e<t.length;e++)this.enable(t[e]);else t instanceof Phaser.Group?this.enable(t.children):(t.hasOwnProperty("body")&&this.enableBody(t.body,o),t.hasOwnProperty("children")&&t.children.length>0&&this.enable(t.children))},Phaser.Plugin.ArcadePolygons.Facade.prototype.enableBody=function(t,o){for(var e=[],r=0;r<o.length;r+=2)e.push(new SAT.Vector(o[r],o[r+1]));var n=new SAT.Polygon(new SAT.Vector(0,0),e);t.sat={polygon:n}},Phaser.Plugin.ArcadePolygons.Facade.prototype.enableSpriteBody=function(t){t.hasOwnProperty("body")||console.error("Enable arcade physics before enabling polygon physics.");var o=t.body,e=new SAT.Box(new SAT.Vector(o.x,o.y),o.width,o.height).toPolygon();o.sat={polygon:e}},Phaser.Plugin.ArcadePolygons.Facade.prototype.enableGroup=function(t,o,e){var r=[];o.forEach(function(t){var o=decomp.quickDecomp(t);o.forEach(function(t){r.push(flatten(t))})}),r.forEach(function(o){var r=e.game.add.sprite(0,0);e.game.physics.arcade.enable(r),e.game.arcadePolygons.enable(r,o),r.body.immovable=!0,r.body.allowGravity=!1,t.add(r)})},Phaser.Plugin.ArcadePolygons.Overrides={},Phaser.Plugin.ArcadePolygons.Overrides.collideSpriteVsGroup=function(t,o,e,r,n,s){if(!t.body)return!1;t.body.sat||console.error("Non polygon object!"),this.debug={vectors:[],normals:[]},this.features={debug:0,speed:1e3,bounce:0,gravity:500,friction:0,slowMotion:1};var i=t.body;i.sat.polygon.pos.x=i.x,i.sat.polygon.pos.y=i.y;for(var p in o.children){var a=o.children[p],l=new SAT.Response,c=SAT.testPolygonPolygon(i.sat.polygon,a.body.sat.polygon,l);if(c){var h=l.overlapV.clone().scale(-1);i.position.x+=h.x,i.position.y+=h.y,i.sat.polygon.pos.x=i.position.x,i.sat.polygon.pos.y=i.position.y;var y=new SAT.Vector(i.velocity.x,i.velocity.y),u=l.overlapN.clone().scale(-1),f=y.clone().projectN(u),g=y.clone().sub(f),d=f.clone().scale(-this.features.bounce),v=g.clone().scale(1-this.features.friction),P=v.clone().add(d);i.velocity.x=P.x,i.velocity.y=P.y,this.features.debug&&(y.name="velocity",h.name="overlapV",u.name="overlapN",f.name="velocityN",g.name="velocityT",d.name="bounce",v.name="friction",P.name="newVelocity",this.debug.vectors.push(y,u,f,g,d,v,P),this.features.debug>1&&(u.colour="#333",d.colour="#25f",v.colour="#f55",P.colour="#5f5",u.scale(50),this.debug.normals.push(u,d,v,P)))}}};